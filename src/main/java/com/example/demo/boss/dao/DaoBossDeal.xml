<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.boss.dao.DaoBossDeal">
	<select id="SelectBossDeals" resultType="com.example.demo.common.UppercasedMap" parameterType="java.util.Map">
		SELECT a.CUSTOMER_DEAL_ID
		,      a.OPEN_YN
		,      a.BOSS_DEAL_ID
		,      b.BOSS_DEAL_ID  AS MY_BOSS_DEAL_ID
		,      a.HOPE_DT
		,      a.HOPE_REGION_CD
		,      ( SELECT code.VLD_VAL_NM
		         FROM   TB_CODES code
		         WHERE  code.CD_KNM = '지역구분코드'
		         AND    code.VLD_VAL = a.HOPE_REGION_CD
		       ) AS HOPE_REGION_NM
		,      a.HOPE_PEOPLE_CNT
		,      a.HOPE_OTHER_CN
		,      a.HOPE_THEME_CD1
		,      ( SELECT code.VLD_VAL_NM
		           FROM TB_CODES code
		          WHERE code.CD_KNM = '테마구분코드'
		            AND code.VLD_VAL = a.HOPE_THEME_CD1
		       ) AS HOPE_THEME_NM1
		,      a.HOPE_THEME_CD2
		,      ( SELECT code.VLD_VAL_NM
		           FROM TB_CODES code
		          WHERE code.CD_KNM = '테마구분코드'
		            AND code.VLD_VAL = a.HOPE_THEME_CD2
		       ) AS HOPE_THEME_NM2
		,      a.HOPE_THEME_CD3
		,      ( SELECT code.VLD_VAL_NM
		           FROM TB_CODES code
		          WHERE code.CD_KNM = '테마구분코드'
		            AND code.VLD_VAL = a.HOPE_THEME_CD3
		       ) AS HOPE_THEME_NM3
		,      ( SELECT COUNT(*)
		           FROM TB_BOSS_DEALS t
		          WHERE t.ORG_CUSTOMER_DEAL_ID = a.CUSTOMER_DEAL_ID
		       ) AS BOSS_DEAL_COUNT
		<if test="BOSS_ID != null">
		,      CASE WHEN EXISTS ( SELECT 1
		                          FROM   TB_BOSS_DEALS b
		                          WHERE  b.ORG_CUSTOMER_DEAL_ID = a.CUSTOMER_DEAL_ID
		                          AND    b.BOSS_ID = #{BOSS_ID}
		                        )
		            THEN 'Y'
		            ELSE 'N'
		       END AS DEAL_SENT_YN
		</if>
		,      b.DEAL_CN AS BOSS_DEAL_CN
		FROM   TB_CUSTOMER_DEALS a
		LEFT   OUTER JOIN
		       TB_BOSS_DEALS b
		ON     b.ORG_CUSTOMER_DEAL_ID = a.CUSTOMER_DEAL_ID
		AND    b.BOSS_ID              = #{BOSS_ID}
		WHERE  1=1
		<if test='DEAL_SENT_YN == "Y"'>
			AND    EXISTS ( SELECT 1
			                  FROM TB_BOSS_DEALS b2
		                     WHERE b2.ORG_CUSTOMER_DEAL_ID = a.CUSTOMER_DEAL_ID
			                   AND b2.BOSS_ID = #{BOSS_ID}
			              )
		</if>
		<if test='DEAL_SENT_YN == "N"'>
			AND    a.OPEN_YN = 'Y'
			AND NOT EXISTS ( SELECT 1
			                   FROM TB_BOSS_DEALS b2
		                      WHERE b2.ORG_CUSTOMER_DEAL_ID = a.CUSTOMER_DEAL_ID
			                    AND b2.BOSS_ID = #{BOSS_ID}
			               )
		</if>
		<if test="CUSTOMER_DEAL_ID != null">
			AND a.CUSTOMER_DEAL_ID = #{CUSTOMER_DEAL_ID}
		</if>
	</select>

	<insert id="InsertBossDeal" parameterType="java.util.Map">
		INSERT INTO TB_BOSS_DEALS (
		BOSS_ID
		, ORG_CUSTOMER_DEAL_ID
		, DEAL_CN
		)
		VALUES (
		#{BOSS_ID}
		, #{ORG_CUSTOMER_DEAL_ID}
		, #{DEAL_CN}
		)
	</insert>

	<insert id="DeleteBossDeal" parameterType="java.util.Map">
		DELETE FROM TB_BOSS_DEALS
		WHERE BOSS_DEAL_ID = #{BOSS_DEAL_ID}
	</insert>
</mapper>